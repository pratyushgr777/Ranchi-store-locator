<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sales Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Techy dark theme */
      --bg:#0b1220;          /* deep navy */
      --panel:#0f172a;       /* slate 900 */
      --card:#0b1220;        /* match bg for seamless cards */
      --surface:#111827;     /* slate 800 */
      --stroke:#1f2937;      /* slate 700 */
      --text:#e5e7eb;        /* gray 200 */
      --muted:#94a3b8;       /* slate 400 */
      --accent:#06b6d4;      /* cyan 500 */
      --accent2:#22d3ee;     /* cyan 400 */
      --accent3:#0ea5e9;     /* sky 500 */
      --good:#22c55e;        /* green */
      --warn:#f59e0b;        /* amber */
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --glow:0 0 0 1px rgba(34,211,238,.25), 0 0 22px rgba(14,165,233,.18);
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(3,105,161,.18), transparent 60%),
        radial-gradient(1400px 700px at 110% 0%, rgba(8,145,178,.18), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      line-height:1.45;
    }

    /* Header */
    .appbar{
      position:sticky; top:0; z-index:50;
      background:rgba(2,6,23,.7); /* slate-950/70 */
      backdrop-filter: blur(8px) saturate(140%);
      border-bottom:1px solid var(--stroke);
    }
    .appbar-inner{
      display:flex; align-items:center; justify-content:space-between;
      max-width:1200px; margin:0 auto; padding:12px 16px;
    }
    .title{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px }
    .title .dot{ width:10px; height:10px; border-radius:50%;
      background: radial-gradient(circle at 35% 35%, var(--accent2), var(--accent3));
      box-shadow: 0 0 18px rgba(34,211,238,.65);
    }
    .period{ color:var(--muted); font-size:13px; display:flex; gap:8px; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      background: linear-gradient(180deg, rgba(30,41,59,.9), rgba(15,23,42,.9));
      border:1px solid var(--stroke); box-shadow: var(--glow);
      color:#cbd5e1;
    }

    /* Buttons */
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(2,6,23,.95));
      color:#e2e8f0;
      padding:10px 14px; border-radius:12px; font-size:14px; cursor:pointer;
      box-shadow: var(--glow);
    }
    .btn:active{ transform: scale(.98); }

    /* Layout */
    .wrap{ max-width:1200px; margin:16px auto; padding:0 16px 30px; display:grid; gap:16px }

    /* Panels */
    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(17,24,39,.95), rgba(2,6,23,.95));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:12px 16px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(2,6,23,.9), rgba(17,24,39,.9));
      font-weight:800; color:var(--accent2); letter-spacing:.2px;
    }
    .panel-b{ padding:14px }

    /* Filters */
    .grid{ display:grid; gap:12px }
    @media (min-width:860px){ .grid-3{ grid-template-columns: repeat(3, 1fr) } }
    .field label{ display:block; font-size:12px; color:var(--muted); margin:6px 4px }
    select{
      width:100%; padding:12px; font-size:16px; color:#dbeafe;
      background: linear-gradient(180deg, rgba(2,6,23,.8), rgba(15,23,42,.8));
      border:1px solid var(--stroke); border-radius:12px; outline:none;
      box-shadow: var(--glow);
    }
    select:focus{ border-color:#0891b2; box-shadow: 0 0 0 3px rgba(34,211,238,.15) }
    select option{ background:#0b1220; color:#e2e8f0 }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px }

    /* KPI tiles */
    .kpis{ display:grid; gap:12px }
    @media (min-width:860px){ .kpis-5{ grid-template-columns: repeat(5, 1fr) } }
    .kpi{
      background: linear-gradient(180deg, rgba(2,6,23,.7), rgba(17,24,39,.7));
      border:1px solid var(--stroke); border-radius:12px; padding:12px;
      box-shadow: var(--glow);
    }
    .kpi .label{ font-size:12px; color:#a3b1c6 }
    .kpi .value{ font-size:20px; font-weight:800; margin-top:4px }
    .kpi .sub{ font-size:12px; color:var(--muted) }

    /* ECO buckets */
    .eco{ display:grid; gap:12px }
    @media (min-width:860px){ .eco{ grid-template-columns: 1fr 1fr } }
    .eco-card{
      border:1px solid var(--stroke); border-radius:12px; padding:12px;
      background: linear-gradient(180deg, rgba(2,6,23,.7), rgba(17,24,39,.7));
      box-shadow: var(--glow);
    }
    .eco-title{ font-weight:800; color:var(--accent2); margin-bottom:6px }
    .eco-row{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border:1px dashed rgba(148,163,184,.3); border-radius:10px; margin-top:8px;
      background: rgba(2,6,23,.5);
    }
    .eco-row .name{ color:#cbd5e1 }
    .eco-row .count{ font-weight:800 }

    /* Brand blocks (vertical) */
    .brand{ display:grid; gap:16px }
    .brand-card{
      border:1px solid var(--stroke); border-radius:14px; padding:12px;
      background: linear-gradient(180deg, rgba(2,6,23,.7), rgba(17,24,39,.7));
      box-shadow: var(--glow);
    }
    .brand-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
    .brand-name{ font-weight:900; color:#e2e8f0; letter-spacing:.2px }
    .badge{ font-size:11px; color:#67e8f9; background: rgba(8,145,178,.15); border:1px solid rgba(34,211,238,.25); padding:4px 8px; border-radius:999px }

    /* Meters */
    .meter{ display:grid; gap:8px; margin:8px 0 14px }
    .meter-head{ display:flex; align-items:center; justify-content:space-between }
    .meter-title{ font-size:14px; color:#cbd5e1; font-weight:600 }
    .meter-pct{ font-weight:800; color:#67e8f9 }
    .bar{
      width:100%; height:12px; border-radius:999px; overflow:hidden;
      background: linear-gradient(90deg, rgba(30,41,59,.8), rgba(15,23,42,.8));
      border:1px solid rgba(148,163,184,.25);
    }
    .fill{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(34,211,238,.9), rgba(14,165,233,.9));
      box-shadow: 0 0 12px rgba(56,189,248,.35);
      transition: width .35s ease;
    }
    .nums{ font-size:12px; color:#a3b1c6 }

    .disclaimer{ color:#94a3b8; font-size:12px; margin-top:6px }

    .actions{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title"><span class="dot"></span><span>Sales Dashboard</span></div>
      <div class="period">
        <span class="pill" id="periodPill">Loading…</span>
        <span class="pill" id="updatedPill" style="display:none;"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Filters -->
    <section class="panel">
      <div class="panel-h">Select Rep (from GTM)</div>
      <div class="panel-b">
        <div class="grid grid-3">
          <div class="field">
            <label for="tsiSel">TSI</label>
            <select id="tsiSel"><option value="">Select TSI</option></select>
          </div>
          <div class="field">
            <label for="dbSel">Distributor Name</label>
            <select id="dbSel"><option value="">Select Distributor</option></select>
          </div>
          <div class="field">
            <label for="dbsrSel">DBSR Name</label>
            <select id="dbsrSel"><option value="">Select DBSR</option></select>
          </div>
        </div>
        <div class="hint" id="keyInfo" style="display:none; margin-top:10px;"></div>

        <!-- Share -->
        <div class="actions">
          <button class="btn" id="waBtn">Share via WhatsApp</button>
        </div>
      </div>
    </section>

    <!-- GTM KPIs -->
    <section class="panel">
      <div class="panel-h">GTM Snapshot</div>
      <div class="panel-b">
        <div class="kpis kpis-5">
          <div class="kpi"><div class="label">OMR (Total Outlets)</div><div class="value" id="kpiOMR">—</div></div>
          <div class="kpi"><div class="label">Geo-tagged Count</div><div class="value" id="kpiGeo">—</div></div>
          <div class="kpi"><div class="label">HHT %</div><div class="value" id="kpiHHT">—</div><div class="sub">Hand-held terminal</div></div>
          <div class="kpi"><div class="label">Avg Geo Bills</div><div class="value" id="kpiAvg">—</div></div>
          <div class="kpi"><div class="label">% Geo-Tagged vs Geo-Fenced</div><div class="value" id="kpiFence">—</div></div>
        </div>

        <div class="eco" style="margin-top:12px;">
          <div class="eco-card">
            <div class="eco-title">Geo-adhered ECO</div>
            <div class="eco-row"><div class="name">&gt; 0 bills</div><div class="count" id="ecoY">—</div></div>
            <div class="eco-row"><div class="name">&ge; 800 bills</div><div class="count" id="ecoZ">—</div></div>
            <div class="hint">Counts adhered to geo-tagging</div>
          </div>
          <div class="eco-card">
            <div class="eco-title">Total ECO</div>
            <div class="eco-row"><div class="name">&gt; 0 bills</div><div class="count" id="ecoAA">—</div></div>
            <div class="eco-row"><div class="name">&ge; 800 bills</div><div class="count" id="ecoAB">—</div></div>
            <div class="hint">Overall counts</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Brand Activation (vertical) -->
    <section class="panel">
      <div class="panel-h">Brand Activation — Current Month</div>
      <div class="panel-b brand">

        <!-- Durex -->
        <div class="brand-card" id="durexCard">
          <div class="brand-head">
            <div class="brand-name">Durex</div>
            <div class="badge" id="dxBadge" style="display:none;">No data this month</div>
          </div>

          <div class="meter" id="dxOverallBox">
            <div class="meter-head">
              <div class="meter-title">Overall Target vs Achieved</div>
              <div class="meter-pct" id="dxOverallPct">—</div>
            </div>
            <div class="bar"><div class="fill"></div></div>
            <div class="nums" id="dxOverallNums">Target — · Ach —</div>
          </div>

          <div class="meter" id="dxEcoBox">
            <div class="meter-head">
              <div class="meter-title">ECO Target vs Achieved</div>
              <div class="meter-pct" id="dxEcoPct">—</div>
            </div>
            <div class="bar"><div class="fill"></div></div>
            <div class="nums" id="dxEcoNums">Target — · Ach —</div>
          </div>

          <div class="meter" id="dxUlsBox">
            <div class="meter-head">
              <div class="meter-title">ULS Target vs Achieved</div>
              <div class="meter-pct" id="dxUlsPct">—</div>
            </div>
            <div class="bar"><div class="fill"></div></div>
            <div class="nums" id="dxUlsNums">Target — · Ach —</div>
          </div>

          <div class="disclaimer" id="dxNote" style="display:none;"></div>
        </div>

        <!-- Mortein -->
        <div class="brand-card" id="morteinCard">
          <div class="brand-head">
            <div class="brand-name">Mortein</div>
            <div class="badge" id="mtBadge" style="display:none;">No data this month</div>
          </div>

          <div class="meter" id="mtOverallBox">
            <div class="meter-head">
              <div class="meter-title">Value Target vs Achieved</div>
              <div class="meter-pct" id="mtOverallPct">—</div>
            </div>
            <div class="bar"><div class="fill"></div></div>
            <div class="nums" id="mtOverallNums">Target — · Ach —</div>
          </div>

          <div class="meter" id="mtEcoBox">
            <div class="meter-head">
              <div class="meter-title">ECO Target vs Achieved</div>
              <div class="meter-pct" id="mtEcoPct">—</div>
            </div>
            <div class="bar"><div class="fill"></div></div>
            <div class="nums" id="mtEcoNums">Target — · Ach —</div>
          </div>

          <div class="disclaimer" id="mtNote" style="display:none;"></div>
        </div>

      </div>
    </section>
  </main>

  <script>
    /***** CONFIG *****/
    const SHEET_ID = "1__EAiE5wIjQYPDamfkeL1QjIUga-NZ-RBTPnFtAxVtY";
    const URLS = {
      gtm:        `https://opensheet.vercel.app/${SHEET_ID}/GTM`,
      durex:      `https://opensheet.vercel.app/${SHEET_ID}/${encodeURIComponent("BA: Durex")}`,
      mortein:    `https://opensheet.vercel.app/${SHEET_ID}/${encodeURIComponent("BA: Mortien")}`,
      basic:      `https://opensheet.vercel.app/${SHEET_ID}/${encodeURIComponent("basic data")}`
    };

    /***** DOM *****/
    const $ = id => document.getElementById(id);
    const periodPill = $("periodPill"), updatedPill = $("updatedPill");

    const tsiSel = $("tsiSel"), dbSel = $("dbSel"), dbsrSel = $("dbsrSel"), keyInfo = $("keyInfo");
    const waBtn = $("waBtn");

    const kpiOMR = $("kpiOMR"), kpiGeo = $("kpiGeo"), kpiHHT = $("kpiHHT"), kpiAvg = $("kpiAvg"), kpiFence = $("kpiFence");
    const ecoY = $("ecoY"), ecoZ = $("ecoZ"), ecoAA = $("ecoAA"), ecoAB = $("ecoAB");

    // Durex elements
    const dxBadge = $("dxBadge"), dxNote = $("dxNote");
    const dxOverallBox = $("dxOverallBox"), dxOverallPct = $("dxOverallPct"), dxOverallNums = $("dxOverallNums");
    const dxEcoBox = $("dxEcoBox"), dxEcoPct = $("dxEcoPct"), dxEcoNums = $("dxEcoNums");
    const dxUlsBox = $("dxUlsBox"), dxUlsPct = $("dxUlsPct"), dxUlsNums = $("dxUlsNums");

    // Mortein elements
    const mtBadge = $("mtBadge"), mtNote = $("mtNote");
    const mtOverallBox = $("mtOverallBox"), mtOverallPct = $("mtOverallPct"), mtOverallNums = $("mtOverallNums");
    const mtEcoBox = $("mtEcoBox"), mtEcoPct = $("mtEcoPct"), mtEcoNums = $("mtEcoNums");

    /***** STATE *****/
    let GTM = [], DUREX = [], MORTEIN = [];
    let SELECTED = { code:"", tsi:"", dist:"", name:"" };

    /***** HELPERS *****/
    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const t = v => (v==null ? "" : String(v).trim());
    function toNum(v){
      if (v==null) return NaN;
      const s = String(v).replace(/[,₹\s]/g,"").replace(/%/g,"");
      const x = parseFloat(s);
      return Number.isFinite(x) ? x : NaN;
    }
    const fmtLakh = n => Number.isFinite(n) ? ("₹ " + n.toLocaleString("en-IN",{maximumFractionDigits:2}) + " L") : "—";
    const fmtPct = n => Number.isFinite(n) ? (n.toFixed(1) + "%") : "—";
    const fmtInt = n => Number.isFinite(n) ? n.toLocaleString("en-IN") : "—";
    const uniq = arr => Array.from(new Set(arr.filter(x => t(x)!=="")));

    const getTxt = el => (el && el.textContent ? el.textContent.trim() : "—");

    function setPillText(month, year, updated){
      const label = (month && year) ? `${month} ${year}` :
        new Date().toLocaleString("en-GB", { month:"long", year:"numeric" });
      periodPill.textContent = `Period: ${label}`;
      if (updated){
        updatedPill.style.display = "inline-flex";
        updatedPill.textContent = `Updated: ${updated}`;
      }
    }

    function meterSet(box, pct){
      const fill = box.querySelector(".fill");
      const w = Math.max(0, Math.min(pct, 100));
      fill.style.width = w + "%";
    }

    function setOverall(boxEls, tgt, ach){
      const [box, pctEl, numsEl] = boxEls;
      const pct = (Number.isFinite(tgt) && tgt>0 && Number.isFinite(ach)) ? (ach/tgt*100) : NaN;
      pctEl.textContent = fmtPct(pct);
      numsEl.innerHTML = `Target <strong>${fmtLakh(tgt)}</strong> · Ach <strong>${fmtLakh(ach)}</strong>`;
      meterSet(box, Number.isFinite(pct) ? pct : 0);
    }

    function setOverallCount(boxEls, tgt, ach){
      const [box, pctEl, numsEl] = boxEls;
      const pct = (Number.isFinite(tgt) && tgt>0 && Number.isFinite(ach)) ? (ach/tgt*100) : NaN;
      pctEl.textContent = fmtPct(pct);
      numsEl.innerHTML = `Target <strong>${fmtInt(tgt)}</strong> · Ach <strong>${fmtInt(ach)}</strong>`;
      meterSet(box, Number.isFinite(pct) ? pct : 0);
    }

    function sumRows(rows, keys){
      const out = {}; keys.forEach(k=>out[k]=0);
      rows.forEach(r => keys.forEach(k => { const val = toNum(r[k]); if (Number.isFinite(val)) out[k]+=val; }));
      return out;
    }

    function avgRows(rows, keys){
      const out = {}; const cnt = {}; keys.forEach(k=>{out[k]=0; cnt[k]=0});
      rows.forEach(r => keys.forEach(k => { const val = toNum(r[k]); if (Number.isFinite(val)) { out[k]+=val; cnt[k]++; } }));
      keys.forEach(k => { if (cnt[k]>0) out[k] = out[k]/cnt[k]; });
      return out;
    }

    function findGtm(tsi, dist, name){
      return GTM.filter(r => t(r["TSI"])===t(tsi) && t(r["Distributor Name"])===t(dist) && t(r["DBSR Name"])===t(name));
    }
    function byCode(arr, code){ return arr.filter(r => t(r["UNIQUE DBSR Code"])===t(code)); }

    /***** LOAD DATA *****/
    async function jget(url){ const r = await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }

    async function boot(){
      // Header info
      try{
        const basic = await jget(URLS.basic);
        let month="", year="", updated="";
        if (Array.isArray(basic) && basic.length){
          const row = basic[0];
          for (const k in row){
            const key = k.toLowerCase();
            const val = t(row[k]);
            if (key.includes("month")) month = val;
            else if (key.includes("year")) year = val;
            else if (key.includes("update") || key.includes("last")) updated = val;
          }
        }
        setPillText(month, year, updated);
      }catch{ setPillText("", "", ""); }

      // GTM
      try{
        const gtm = await jget(URLS.gtm);
        GTM = gtm.map(r => ({
          "UNIQUE DBSR Code": t(r["UNIQUE DBSR Code"]),
          "TSI": t(r["TSI"] ?? r["E"]),
          "Distributor Name": t(r["Distributor Name"]),
          "DBSR Name": t(r["DBSR Name"]),
          "HHT %": t(r["HHT %"]),
          "Avg Geo Bills": t(r["Avg Geo Bills"]),
          "OMR": t(r["OMR"]),
          "Geo Tagged Count": t(r["Geo Tagged Count"]) || t(r["Geo Tagged"]) || t(r["Geo Tagged count"]) || t(r["X"]),
          ">0 Eco(Geo) Y": t(r[">0 Eco(Geo)"]) || t(r["Y"]) || t(r[">0 Eco (Geo)"]),
          ">=800 Eco(Geo) Z": t(r[">=800 Eco(Geo)"]) || t(r["Z"]) || t(r[">=800 Eco (Geo)"]),
          ">0 Eco(total) AA": t(r[">0 Eco(total)"]) || t(r["AA"]) || t(r[">0 Eco (total)"]),
          ">=800 Eco(total) AB": t(r[">=800 Eco(total)"]) || t(r["AB"]) || t(r[">=800 Eco (total)"]),
          "% Geo Tagged vs Geo Fencend": t(r["% Geo Tagged vs Geo Fencend"]) || t(r["% Geo Tagged vs Geo Fenced"]) || t(r["AC"])
        }));
        // Build filters
        const tsis = uniq(GTM.map(r=>r["TSI"])).sort((a,b)=>a.localeCompare(b));
        tsiSel.innerHTML = `<option value="">Select TSI</option>` + tsis.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
      }catch(e){
        tsiSel.innerHTML = `<option value="">Failed to load GTM</option>`;
      }

      // Durex
      try{
        const dx = await jget(URLS.durex);
        DUREX = dx.map(r => ({
          "UNIQUE DBSR Code": t(r["UNIQUE DBSR Code"]),
          "TSI": t(r["TSI"]),
          "Distributor Name": t(r["Distributor Name"]),
          "DBSR Name": t(r["DBSR Name"]),
          "TGT": t(r["TGT"]),
          "ACH": t(r["ACH"]),
          "ECO TGT": t(r["ECO TGT"]),
          "ECO ACH": t(r["ECO ACH"]),
          "ULS TGT": t(r["ULS TGT"]),
          "ULS ACH": t(r["ULS ACH"])
        }));
      }catch{ DUREX = []; }

      // Mortein
      try{
        const mt = await jget(URLS.mortein);
        MORTEIN = mt.map(r => ({
          "UNIQUE DBSR Code": t(r["UNIQUE DBSR Code"]),
          "TSI": t(r["TSI"]),
          "Distributor Name": t(r["Distributor Name"]),
          "DBSR Name": t(r["DBSR Name"]),
          "OMR": t(r["OMR"]),
          "VAL TGT": t(r["VAL TGT"]),
          "VAL ACH": t(r["VAL ACH"]),
          "ECO TGT": t(r["ECO TGT"]),
          "ECO ACH": t(r["ECO ACH"])
        }));
      }catch{ MORTEIN = []; }
    }

    /***** EVENTS *****/
    tsiSel.addEventListener("change", ()=>{
      const sel = t(tsiSel.value);
      const dists = uniq(GTM.filter(r=>t(r["TSI"])===sel).map(r=>r["Distributor Name"])).sort((a,b)=>a.localeCompare(b));
      dbSel.innerHTML = `<option value="">Select Distributor</option>` + dists.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
      dbsrSel.innerHTML = `<option value="">Select DBSR</option>`;
      keyInfo.style.display = "none";
      clearAll();
    });

    dbSel.addEventListener("change", ()=>{
      const selT = t(tsiSel.value), selD = t(dbSel.value);
      const reps = uniq(GTM.filter(r=>t(r["TSI"])===selT && t(r["Distributor Name"])===selD).map(r=>r["DBSR Name"])).sort((a,b)=>a.localeCompare(b));
      dbsrSel.innerHTML = `<option value="">Select DBSR</option>` + reps.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join("");
      keyInfo.style.display = "none";
      clearAll();
    });

    dbsrSel.addEventListener("change", ()=>{
      const selT = t(tsiSel.value), selD = t(dbSel.value), selN = t(dbsrSel.value);
      if (!selT || !selD || !selN) return;
      const rows = findGtm(selT, selD, selN);
      if (!rows.length){
        keyInfo.style.display = "block";
        keyInfo.textContent = "No GTM row found for selection.";
        clearAll();
        return;
      }
      const code = rows[0]["UNIQUE DBSR Code"];
      SELECTED = { code, tsi: selT, dist: selD, name: selN };

      keyInfo.style.display = "block";
      keyInfo.innerHTML = `Code: <strong>${esc(code || "-")}</strong>${rows.length>1 ? ' • <span class="disclaimer">Multiple GTM rows; aggregated</span>' : ''}`;

      // Top KPIs from GTM (sum counts, avg percentages/avg)
      const sum = sumRows(rows, ["OMR","Geo Tagged Count",">0 Eco(Geo) Y",">=800 Eco(Geo) Z",">0 Eco(total) AA",">=800 Eco(total) AB"]);
      const avg = avgRows(rows, ["HHT %","Avg Geo Bills","% Geo Tagged vs Geo Fencend"]);
      kpiOMR.textContent = Number.isFinite(toNum(sum["OMR"])) ? toNum(sum["OMR"]).toLocaleString("en-IN") : "—";
      kpiGeo.textContent = Number.isFinite(toNum(sum["Geo Tagged Count"])) ? toNum(sum["Geo Tagged Count"]).toLocaleString("en-IN") : "—";
      kpiHHT.textContent = fmtPct(toNum(avg["HHT %"]));
      kpiAvg.textContent = Number.isFinite(toNum(avg["Avg Geo Bills"])) ? toNum(avg["Avg Geo Bills"]).toFixed(1) : "—";
      kpiFence.textContent = fmtPct(toNum(avg["% Geo Tagged vs Geo Fencend"]));

      // ECO buckets (corrected mapping)
      // Geo-adhered ECO -> Y / Z
      ecoY.textContent  = Number.isFinite(toNum(sum[">0 Eco(Geo) Y"])) ? toNum(sum[">0 Eco(Geo) Y"]).toLocaleString("en-IN") : "—";
      ecoZ.textContent  = Number.isFinite(toNum(sum[">=800 Eco(Geo) Z"])) ? toNum(sum[">=800 Eco(Geo) Z"]).toLocaleString("en-IN") : "—";
      // Total ECO -> AA / AB
      ecoAA.textContent = Number.isFinite(toNum(sum[">0 Eco(total) AA"])) ? toNum(sum[">0 Eco(total) AA"]).toLocaleString("en-IN") : "—";
      ecoAB.textContent = Number.isFinite(toNum(sum[">=800 Eco(total) AB"])) ? toNum(sum[">=800 Eco(total) AB"]).toLocaleString("en-IN") : "—";

      // Brand Activation rendering
      renderBrands(code);
    });

    function clearAll(){
      [kpiOMR,kpiGeo,kpiHHT,kpiAvg,kpiFence,ecoY,ecoZ,ecoAA,ecoAB].forEach(el => el.textContent="—");
      // reset meters
      resetBrand("dx");
      resetBrand("mt");
    }

    function resetBrand(prefix){
      const badge = (prefix==="dx")?dxBadge:mtBadge;
      const note  = (prefix==="dx")?dxNote:mtNote;
      const boxes = prefix==="dx"
        ? [dxOverallBox,dxEcoBox,dxUlsBox]
        : [mtOverallBox,mtEcoBox];
      badge.style.display = "none";
      note.style.display = "none";
      boxes.forEach(b => meterSet(b, 0));
      const pctIds = prefix==="dx"
        ? [dxOverallPct,dxEcoPct,dxUlsPct]
        : [mtOverallPct,mtEcoPct];
      const numIds = prefix==="dx"
        ? [dxOverallNums,dxEcoNums,dxUlsNums]
        : [mtOverallNums,mtEcoNums];
      pctIds.forEach(p=>p.textContent="—");
      numIds.forEach(n=>n.textContent="Target — · Ach —");
    }

    function renderBrands(code){
      // Durex
      const dxRows = byCode(DUREX, code);
      resetBrand("dx");
      if (dxRows.length){
        const s1 = sumRows(dxRows, ["TGT","ACH"]);
        setOverall([dxOverallBox, dxOverallPct, dxOverallNums], toNum(s1["TGT"]), toNum(s1["ACH"]));

        const s2 = sumRows(dxRows, ["ECO TGT","ECO ACH"]);
        setOverallCount([dxEcoBox, dxEcoPct, dxEcoNums], toNum(s2["ECO TGT"]), toNum(s2["ECO ACH"]));

        const s3 = sumRows(dxRows, ["ULS TGT","ULS ACH"]);
        setOverallCount([dxUlsBox, dxUlsPct, dxUlsNums], toNum(s3["ULS TGT"]), toNum(s3["ULS ACH"]));

        if (dxRows.length>1){ dxNote.style.display="block"; dxNote.textContent="Multiple Durex rows for this code; summed totals shown."; }
      } else {
        dxBadge.style.display = "inline-flex";
      }

      // Mortein
      const mtRows = byCode(MORTEIN, code);
      resetBrand("mt");
      if (mtRows.length){
        const s1 = sumRows(mtRows, ["VAL TGT","VAL ACH"]);
        setOverall([mtOverallBox, mtOverallPct, mtOverallNums], toNum(s1["VAL TGT"]), toNum(s1["VAL ACH"]));

        const s2 = sumRows(mtRows, ["ECO TGT","ECO ACH"]);
        setOverallCount([mtEcoBox, mtEcoPct, mtEcoNums], toNum(s2["ECO TGT"]), toNum(s2["ECO ACH"]));

        if (mtRows.length>1){ mtNote.style.display="block"; mtNote.textContent="Multiple Mortein rows for this code; summed totals shown."; }
      } else {
        mtBadge.style.display = "inline-flex";
      }
    }

    /* WhatsApp share */
    function buildWhatsAppMessage(){
      if (!SELECTED.code || !SELECTED.name){
        return "Please select TSI, Distributor, and DBSR first.";
      }

      // Top KPIs
      const k_omr   = getTxt(kpiOMR);
      const k_geo   = getTxt(kpiGeo);
      const k_hht   = getTxt(kpiHHT);
      const k_avg   = getTxt(kpiAvg);
      const k_fence = getTxt(kpiFence);

      // ECO buckets (corrected labels)
      const y  = getTxt(ecoY);
      const z  = getTxt(ecoZ);
      const aa = getTxt(ecoAA);
      const ab = getTxt(ecoAB);

      // Brand lines (we reuse what's already rendered)
      // Durex
      const dxOverall = `${getTxt(dxOverallNums)} (${getTxt(dxOverallPct)})`;
      const dxEco     = `${getTxt(dxEcoNums)} (${getTxt(dxEcoPct)})`;
      const dxUls     = `${getTxt(dxUlsNums)} (${getTxt(dxUlsPct)})`;

      // Mortein
      const mtOverall = `${getTxt(mtOverallNums)} (${getTxt(mtOverallPct)})`;
      const mtEco     = `${getTxt(mtEcoNums)} (${getTxt(mtEcoPct)})`;

      const header = [
        `DBSR: ${SELECTED.name} (${SELECTED.dist})`,
        `TSI: ${SELECTED.tsi} | Code: ${SELECTED.code}`
      ].join("\n");

      const kpis = [
        `OMR ${k_omr} | Geo-tagged ${k_geo} | HHT ${k_hht}`,
        `Avg Geo Bills ${k_avg} | GeoTag vs Fenced ${k_fence}`
      ].join("\n");

      const eco = [
        `ECO (Geo-adhered): >0 ${y} | ≥800 ${z}`,
        `ECO (Total):       >0 ${aa} | ≥800 ${ab}`
      ].join("\n");

      const brands = [
        `Durex Overall: ${dxOverall}`,
        `Durex ECO:     ${dxEco}`,
        `Durex ULS:     ${dxUls}`,
        ``,
        `Mortein Overall: ${mtOverall}`,
        `Mortein ECO:     ${mtEco}`
      ].join("\n");

      return [header, "", kpis, "", eco, "", brands].join("\n");
    }

    function shareWhatsApp(){
      const msg = buildWhatsAppMessage();
      const url = "https://wa.me/?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
    }

    waBtn.addEventListener("click", shareWhatsApp);

    // Boot
    boot();
  </script>
</body>
</html>
