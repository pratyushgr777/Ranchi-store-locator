<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sales Data Connector (4 Tabs)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#faf7f7; --text:#1f1f1f; --muted:#626262; --card:#fff; --stroke:#e9d9d9;
      --accent:#c62828; --accent2:#e53935; --radius:14px; --shadow:0 8px 26px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:
      radial-gradient(800px 500px at 10% -10%, #ffebee, transparent 60%),
      radial-gradient(700px 500px at 110% 0%, #fff3f3, transparent 60%),
      var(--bg);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .appbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);
      backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--stroke)}
    .appbar-inner{display:flex;align-items:center;justify-content:space-between;max-width:1100px;margin:0 auto;padding:12px 16px}
    .title{display:flex;gap:10px;align-items:center;color:var(--accent);font-weight:800}
    .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 35% 35%, var(--accent2), var(--accent));box-shadow:0 0 10px rgba(230,57,53,.55)}
    .btn{appearance:none;border:1px solid var(--stroke);background:linear-gradient(180deg,#fff,#fff7f7);color:var(--text);
      padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer;box-shadow:var(--shadow)}
    .wrap{max-width:1100px;margin:16px auto;padding:0 16px 24px;display:grid;gap:16px}
    .card{border:1px solid var(--stroke);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow);overflow:hidden}
    .card-h{padding:10px 14px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg,#fff,#fff6f6);font-weight:700;color:var(--accent)}
    .card-b{padding:12px}
    .status{display:grid;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;border:1px dashed #f1e4e4;border-radius:10px;padding:10px 12px}
    .ok{color:#106b21;font-weight:700}
    .err{color:#8b1212;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #f1e4e4;font-size:14px}
    th{text-align:left;color:var(--muted)}
    .small{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title"><span class="dot"></span><span>Sales Data Connector</span></div>
      <button id="refreshBtn" class="btn">Refresh</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-h">Connection status</div>
      <div class="card-b">
        <div id="status" class="status"></div>
        <div id="totals" class="small" style="margin-top:8px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="card-h">Sample preview (first 20 rows merged)</div>
      <div class="card-b">
        <div id="previewNote" class="small" style="margin-bottom:8px;">Once you confirm column headers, I’ll add KPIs and charts.</div>
        <div style="overflow:auto;">
          <table>
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---- YOUR SHEET & TABS ----
    const SHEET_ID = "1__EAiE5wIjQYPDamfkeL1QjIUga-NZ-RBTPnFtAxVtY";
    const TABS = ["BA: Durex","BA: Mortien","GTM","Bill Cut"]; // exact tab names

    // Build encoded URLs for each tab
    const tabURLs = TABS.map(tab => ({
      tab,
      url: `https://opensheet.vercel.app/${SHEET_ID}/${encodeURIComponent(tab)}`
    }));

    const $ = id => document.getElementById(id);
    const statusEl = $("status");
    const totalsEl = $("totals");
    const thead = $("thead");
    const tbody = $("tbody");

    async function loadAll() {
      statusEl.innerHTML = "";
      totalsEl.textContent = "";

      // fetch each tab, show per-tab status
      const results = await Promise.allSettled(
        tabURLs.map(({tab, url}) =>
          fetch(url).then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          }).then(rows => ({ tab, rows }))
        )
      );

      let merged = [];
      let total = 0;

      results.forEach((res, i) => {
        if (res.status === "fulfilled") {
          const { tab, rows } = res.value;
          total += rows.length;
          merged = merged.concat(rows.map(r => ({ __TAB__: tab, ...r })));
          addStatusRow(tab, rows.length, true);
        } else {
          const { tab } = tabURLs[i];
          addStatusRow(tab, 0, false, String(res.reason));
        }
      });

      totalsEl.textContent = `Combined rows loaded: ${total.toLocaleString()} (across ${TABS.length} tabs)`;

      // Render a sample preview (first 20 rows), showing the union of keys
      renderPreview(merged.slice(0, 20));
    }

    function addStatusRow(tab, count, ok, err="") {
      const div = document.createElement("div");
      div.className = "row";
      div.innerHTML = `
        <div><strong>${tab}</strong></div>
        <div>${ok ? `<span class="ok">Connected ✓</span>` : `<span class="err">Error ✕</span>`}</div>
        <div class="small">${ok ? `${count.toLocaleString()} rows` : err}</div>
      `;
      statusEl.appendChild(div);
    }

    function renderPreview(rows) {
      if (!rows.length) {
        thead.innerHTML = "";
        tbody.innerHTML = "<tr><td>No rows to preview.</td></tr>";
        return;
      }
      // union of keys across sample
      const cols = Array.from(rows.reduce((set, r) => {
        Object.keys(r).forEach(k => set.add(k));
        return set;
      }, new Set()));

      // header
      thead.innerHTML = `<tr>${cols.map(c => `<th>${escapeHtml(c)}</th>`).join("")}</tr>`;

      // body
      tbody.innerHTML = rows.map(r =>
        `<tr>${cols.map(c => `<td>${escapeHtml(String(r[c] ?? ""))}</td>`).join("")}</tr>`
      ).join("");
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    }

    $("refreshBtn").addEventListener("click", loadAll);
    loadAll();
  </script>
</body>
</html>
