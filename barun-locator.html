<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barun – Store Locator (Red Theme + Distance List)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #faf7f7;
      --text: #1f1f1f;
      --muted: #626262;
      --card: #ffffff;
      --stroke: #e9d9d9;
      --accent: #c62828;   /* main red for outlets */
      --accent-2: #e53935; /* lighter red */
      --green: #17bf63;    /* user location dot */
      --radius: 14px;
      --shadow: 0 8px 26px rgba(0,0,0,0.08);
    }
    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background:
        radial-gradient(800px 500px at 10% -10%, #ffebee, transparent 60%),
        radial-gradient(700px 500px at 110% 0%, #fff3f3, transparent 60%),
        var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      line-height: 1.45;
    }

    /* Header */
    .appbar {
      position: sticky; top: 0; z-index: 50;
      background: rgba(255,255,255,0.9);
      backdrop-filter: saturate(140%) blur(6px);
      border-bottom: 1px solid var(--stroke);
    }
    .appbar-inner {
      display: flex; align-items: center; justify-content: space-between;
      max-width: 1100px; margin: 0 auto; padding: 12px 16px;
    }
    .title {
      display: flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: .2px;
      color: var(--accent);
    }
    .title .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, var(--accent-2), var(--accent));
      box-shadow: 0 0 10px rgba(230, 57, 53, 0.55);
    }
    .btn {
      appearance: none; border: 1px solid var(--stroke);
      background: linear-gradient(180deg, #fff, #fff7f7);
      color: var(--text);
      padding: 10px 14px; border-radius: 10px;
      font-size: 15px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      box-shadow: var(--shadow);
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
      touch-action: manipulation;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      border-color: #f2b5b5;
      background: linear-gradient(180deg, #ffe5e5, #ffdede);
      color: #8b1212;
    }

    /* Layout */
    .wrap {
      max-width: 1100px; margin: 16px auto; padding: 0 16px 24px;
      display: grid; gap: 16px;
    }

    /* Banner for geolocation help */
    .banner {
      display: none;
      border: 1px solid #ffd4d4;
      background: #fff7f7;
      color: #8b1212;
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
    }
    .banner.show { display: block; }

    /* Filters panel */
    .panel {
      border: 1px solid var(--stroke); border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, #fff, #fff6f6);
    }
    .panel-header h3 { margin: 0; font-size: 16px; font-weight: 700; color: var(--accent); }
    .panel-content {
      display: grid; gap: 10px; padding: 12px; grid-template-columns: 1fr;
    }
    @media (min-width: 860px) { .panel-content { grid-template-columns: repeat(4, 1fr); } }

    .field label {
      display: block; font-size: 13px; color: var(--muted);
      margin: 6px 2px 6px;
    }

    /* Dropdowns with clear contrast */
    select {
      width: 100%; padding: 12px 12px; font-size: 16px;
      color: #111; background: #f4f6fb; /* light bluish/grey */
      border: 1px solid #d9dfe8; border-radius: 10px; outline: none;
    }
    select:focus { border-color: #f5a0a0; box-shadow: 0 0 0 3px #ffe3e3; }
    select option { background: #ffffff; color: #000; }

    /* Map + info + distance list */
    .map-card {
      border: 1px solid var(--stroke); border-radius: var(--radius);
      background: var(--card); box-shadow: var(--shadow);
      overflow: hidden;
    }
    #map { width: 100%; height: 52vh; min-height: 320px; }
    .info {
      padding: 12px 14px; border-top: 1px solid var(--stroke);
      background: linear-gradient(180deg, #fff, #fff7f7);
    }
    .info p { margin: 0; color: var(--muted); }
    .info strong { color: var(--text); }

    .list-card {
      border: 1px solid var(--stroke); border-radius: var(--radius);
      background: var(--card); box-shadow: var(--shadow);
      overflow: hidden;
    }
    .list-header {
      padding: 10px 14px; border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, #fff, #fff6f6);
      font-weight: 700; color: var(--accent);
    }
    .list {
      max-height: 40vh; overflow: auto;
    }
    .row {
      display: flex; justify-content: space-between; gap: 8px;
      padding: 10px 14px; border-bottom: 1px solid #f1e4e4;
      cursor: pointer;
    }
    .row:hover { background: #fff3f3; }
    .row .name { font-weight: 600; }
    .row .meta { color: var(--muted); font-size: 13px; }
    .row .dist { font-weight: 700; color: #0c5b2a; } /* greenish for distance */
  </style>
</head>
<body>

  <!-- Sticky header -->
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title">
        <span class="dot"></span>
        <span>Barun — Store Locator</span>
      </div>
      <div>
        <button id="useMyLocation" class="btn btn-primary">Use my location</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Banner if geolocation denied -->
    <div id="geoBanner" class="banner">
      Location access is off. To enable: tap the 🔒 icon in the address bar → Site settings → Location → Allow, then refresh.
    </div>

    <!-- Filters -->
    <section class="panel">
      <div class="panel-header">
        <h3>Filters</h3>
      </div>
      <div class="panel-content">
        <div class="field">
          <label for="dbSelect">DB Name</label>
          <select id="dbSelect"><option value="ALL">All</option></select>
        </div>
        <div class="field">
          <label for="dbsrSelect">DBSR Name</label>
          <select id="dbsrSelect"><option value="ALL">All</option></select>
        </div>
        <div class="field">
          <label for="beatSelect">Beat</label>
          <select id="beatSelect"><option value="ALL">All</option></select>
        </div>
        <div class="field">
          <label for="customerSelect">Customer</label>
          <select id="customerSelect"><option value="ALL">All</option></select>
        </div>
      </div>
    </section>

    <!-- Map -->
    <section class="map-card">
      <div id="map"></div>
      <div class="info">
        <p id="infoPanel">Pick filters to view outlets. Tap a marker for details.</p>
      </div>
    </section>

    <!-- Distance list -->
    <section class="list-card">
      <div class="list-header">Outlets by distance (from your location)</div>
      <div id="distanceList" class="list">
        <!-- rows injected here -->
      </div>
    </section>
  </main>

  <script>
    // Source: "Barun" tab of your sheet
    const sheetURL = "https://opensheet.vercel.app/1Cx09yjWN8lju1jZENNuMB4nLdEV1NDTay_miEc6r0Ys/Barun";

    // Helpers
    const t = v => (v == null ? "" : String(v).trim());
    const n = v => { const x = parseFloat(v); return Number.isFinite(x) ? x : NaN; };
    const escapeHtml = s => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const uniqSorted = arr => [...new Set(arr.filter(v => t(v) !== ""))].sort((a,b)=>String(a).localeCompare(String(b),undefined,{sensitivity:'base'}));
    const km = d => Math.round((d + Number.EPSILON) * 100) / 100;

    // Haversine
    function haversineKm(lat1, lon1, lat2, lon2) {
      const toRad = d => (d * Math.PI) / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Flexible headers
    function getVal(row, candidates) {
      for (const key of candidates) {
        if (key in row && t(row[key]) !== "") return row[key];
        const norm = s => String(s).toLowerCase().replace(/\s+/g," ").trim();
        const wanted = norm(key);
        for (const k in row) if (norm(k) === wanted && t(row[k]) !== "") return row[k];
      }
      return "";
    }

    // Column candidates (supports “Beat Name” and “Beat”)
    const CANDS = {
      DB:       ["DB NAME","DB Name","DB"],
      DBSR:     ["DBSR name","DBSR Name","DBSR"],
      BEAT:     ["Beat Name","Beat"],
      CUSTOMER: ["Customer Name","Customer"],
      LAT:      ["Latitude","Lat"],
      LON:      ["Longitude","Long","Lng"]
    };

    // State
    let data = []; // normalized rows: {db, dbsr, beat, customer, lat, lon}
    let map, infoWindow;
    let markers = []; // array of google.maps.Marker
    let userMarker = null, userLatLng = null;

    // DOM getters
    const $db   = () => document.getElementById("dbSelect");
    const $dbsr = () => document.getElementById("dbsrSelect");
    const $beat = () => document.getElementById("beatSelect");
    const $cust = () => document.getElementById("customerSelect");
    const $info = () => document.getElementById("infoPanel");
    const $list = () => document.getElementById("distanceList");
    const $banner = () => document.getElementById("geoBanner");

    // Build select with raw values; keep previous value if still valid
    function populateSelect(el, values, keepValue = true) {
      const prev = keepValue ? el.value : null;
      while (el.firstChild) el.removeChild(el.firstChild);

      const optAll = document.createElement('option');
      optAll.value = 'ALL'; optAll.textContent = 'All';
      el.appendChild(optAll);

      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;           // raw value
        opt.textContent = v;     // visible label
        el.appendChild(opt);
      });

      if (keepValue && prev && (prev === 'ALL' || values.includes(prev))) el.value = prev;
    }

    /* MAP */
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 23.3441, lng: 85.3096 }, // Ranchi
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
      });
      infoWindow = new google.maps.InfoWindow();

      // try to get current location immediately
      navigator.geolocation?.getCurrentPosition(pos => {
        setUserLocation(pos.coords.latitude, pos.coords.longitude);
      }, err => {
        if (err && err.code === 1) { // PERMISSION_DENIED
          $banner().classList.add('show');
        }
      });
    }

    function setUserLocation(lat, lng) {
      userLatLng = { lat, lng };
      if (!userMarker) {
        userMarker = new google.maps.Marker({
          position: userLatLng,
          map,
          title: "Your Location",
          zIndex: 9999,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 12,                 // bigger & prominent
            fillColor: "#17bf63",      // green
            fillOpacity: 1,
            strokeWeight: 3,
            strokeColor: "#ffffff"
          }
        });
      } else {
        userMarker.setPosition(userLatLng);
        userMarker.setMap(map);
      }
      // refresh distance list whenever we get/refresh location
      buildDistanceList(filteredList());
    }

    function clearMarkers(){ markers.forEach(m => m.setMap(null)); markers = []; }

    function fitToMarkers(includeUser = true) {
      const bounds = new google.maps.LatLngBounds();
      let any = false;
      markers.forEach(m => { bounds.extend(m.getPosition()); any = true; });
      if (includeUser && userLatLng) { bounds.extend(userLatLng); any = true; }
      if (any) {
        map.fitBounds(bounds);
        google.maps.event.addListenerOnce(map, "bounds_changed", () => {
          if (map.getZoom() > 15) map.setZoom(15);
        });
      }
    }

    function makeMarker(entry) {
      if (!Number.isFinite(entry.lat) || !Number.isFinite(entry.lon)) return null;
      const gmaps = `https://www.google.com/maps?q=${entry.lat},${entry.lon}`;
      const marker = new google.maps.Marker({
        map,
        position: { lat: entry.lat, lng: entry.lon },
        title: entry.customer || "(No name)",
        // outlets in red theme
        icon: {
          url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28">
              <circle cx="14" cy="14" r="8" fill="${'#c62828'}" stroke="white" stroke-width="2"/>
            </svg>
          `)}`
        }
      });
      marker.addListener("click", () => {
        infoWindow.setContent(`
          <div style="min-width:220px">
            <strong>${escapeHtml(entry.customer || "")}</strong><br/>
            DB: ${escapeHtml(entry.db || "-")}<br/>
            DBSR: ${escapeHtml(entry.dbsr || "-")}<br/>
            Beat: ${escapeHtml(entry.beat || "-")}<br/>
            <a href="${gmaps}" target="_blank">Open in Google Maps</a>
          </div>
        `);
        infoWindow.open(map, marker);
        // select in Customer dropdown
        const custSel = $cust();
        if (custSel) {
          const match = [...custSel.options].find(o => o.value === (entry.customer || ""));
          if (match) custSel.value = entry.customer || "";
        }
        renderInfoPanel([entry]);
      });
      // attach entry for list clicks
      marker.__entry = entry;
      return marker;
    }

    function renderMarkers(list) {
      clearMarkers();
      list.forEach(e => { const m = makeMarker(e); if (m) markers.push(m); });
      fitToMarkers(true);
    }

    function renderInfoPanel(list) {
      if (!list || list.length === 0) { $info().innerHTML = "No outlets match the current filters."; return; }
      if (list.length === 1) {
        const e = list[0];
        const link = (Number.isFinite(e.lat) && Number.isFinite(e.lon)) ? `https://www.google.com/maps?q=${e.lat},${e.lon}` : "#";
        $info().innerHTML = `
          <strong>${escapeHtml(e.customer || "")}</strong><br/>
          DB: ${escapeHtml(e.db || "-")}<br/>
          DBSR: ${escapeHtml(e.dbsr || "-")}<br/>
          Beat: ${escapeHtml(e.beat || "-")}<br/>
          ${Number.isFinite(e.lat) ? `Lat: ${e.lat}` : ""} ${Number.isFinite(e.lon) ? ` | Lon: ${e.lon}` : ""}<br/>
          <a href="${link}" target="_blank">Open in Google Maps</a>
        `;
      } else {
        $info().innerHTML = `Showing <strong>${list.length}</strong> outlets. Tap a marker for details.`;
      }
    }

    /* DATA + FILTERS + DISTANCE LIST */
    function filteredList() {
      const dbVal   = $db().value;
      const dbsrVal = $dbsr().value;
      const beatVal = $beat().value;
      const custVal = $cust().value;

      let list = data.slice();
      if (dbVal   !== "ALL") list = list.filter(e => t(e.db)   === t(dbVal));
      if (dbsrVal !== "ALL") list = list.filter(e => t(e.dbsr) === t(dbsrVal));
      if (beatVal !== "ALL") list = list.filter(e => t(e.beat) === t(beatVal));
      if (custVal !== "ALL") list = list.filter(e => t(e.customer) === t(custVal));
      return list;
    }

    function rebuildDBSR() {
      const dbVal = $db().value;
      let list = data.slice();
      if (dbVal !== "ALL") list = list.filter(e => t(e.db) === t(dbVal));
      populateSelect($dbsr(), uniqSorted(list.map(e => e.dbsr)), true);
    }

    function rebuildBeat() {
      const dbVal = $db().value, dbsrVal = $dbsr().value;
      let list = data.slice();
      if (dbVal   !== "ALL") list = list.filter(e => t(e.db)   === t(dbVal));
      if (dbsrVal !== "ALL") list = list.filter(e => t(e.dbsr) === t(dbsrVal));
      populateSelect($beat(), uniqSorted(list.map(e => e.beat)), true);
    }

    function rebuildCustomer() {
      const list = filteredList(); // uses current DB/DBSR/Beat
      populateSelect($cust(), uniqSorted(list.map(e => e.customer)), false);
    }

    function applyFiltersAndRender() {
      const list = filteredList();
      renderMarkers(list);
      renderInfoPanel(list);
      buildDistanceList(list);
    }

    function buildDistanceList(list) {
      const box = $list();
      box.innerHTML = "";
      if (!userLatLng) {
        box.innerHTML = `<div class="row"><div class="meta">Location off — tap “Use my location” or enable location permission to see distances.</div></div>`;
        return;
      }
      // build array with distance
      const withDist = list
        .filter(e => Number.isFinite(e.lat) && Number.isFinite(e.lon))
        .map(e => ({
          ...e,
          dist: haversineKm(userLatLng.lat, userLatLng.lng, e.lat, e.lon)
        }))
        .sort((a,b) => a.dist - b.dist);

      if (withDist.length === 0) {
        box.innerHTML = `<div class="row"><div class="meta">No mappable outlets in this filter.</div></div>`;
        return;
      }

      withDist.forEach(e => {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <div class="name">${escapeHtml(e.customer || "")}</div>
            <div class="meta">DB: ${escapeHtml(e.db || "-")} • DBSR: ${escapeHtml(e.dbsr || "-")} • Beat: ${escapeHtml(e.beat || "-")}</div>
          </div>
          <div class="dist">${km(e.dist)} km</div>
        `;
        row.addEventListener("click", () => {
          // find matching marker by coords
          const m = markers.find(mk => {
            const p = mk.getPosition();
            return Math.abs(p.lat() - e.lat) < 1e-8 && Math.abs(p.lng() - e.lon) < 1e-8;
          });
          if (m) {
            map.setCenter(m.getPosition());
            map.setZoom(15);
            google.maps.event.trigger(m, "click");
          }
        });
        box.appendChild(row);
      });
    }

    async function initData() {
      const res = await fetch(sheetURL);
      const raw = await res.json();

      data = raw.map(r => ({
        db:       t(getVal(r, CANDS.DB)),
        dbsr:     t(getVal(r, CANDS.DBSR)),
        beat:     t(getVal(r, CANDS.BEAT)),     // “Beat Name” or “Beat”
        customer: t(getVal(r, CANDS.CUSTOMER)),
        lat:      n(getVal(r, CANDS.LAT)),
        lon:      n(getVal(r, CANDS.LON)),
      }));

      populateSelect($db(),   uniqSorted(data.map(e => e.db)),   true);
      rebuildDBSR(); rebuildBeat(); rebuildCustomer();
      applyFiltersAndRender();
    }

    // Events
    $db().addEventListener("change", () => { rebuildDBSR(); rebuildBeat(); rebuildCustomer(); applyFiltersAndRender(); });
    $dbsr().addEventListener("change", () => { rebuildBeat(); rebuildCustomer(); applyFiltersAndRender(); });
    $beat().addEventListener("change", () => { rebuildCustomer(); applyFiltersAndRender(); });
    $cust().addEventListener("change", () => applyFiltersAndRender());

    // Header button
    document.getElementById("useMyLocation").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          $banner().classList.remove('show');
          setUserLocation(pos.coords.latitude, pos.coords.longitude);
          map.setCenter(userLatLng); map.setZoom(14);
        }, err => {
          if (err && err.code === 1) { // denied
            $banner().classList.add('show');
            alert("Location permission is blocked. Tap the lock icon → Site settings → Allow Location, then refresh.");
          }
        });
      } else {
        alert("Geolocation not supported on this device/browser.");

// Boot

initData();

</script>

<!-- Google Maps JS API -->

<script

src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDmJhoaeBL3cDKrucjCZj mNm2uYi_WguL8&callback=initMap" async defer>

  
</script>
</body>
</html>
