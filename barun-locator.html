<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Barun ‚Äì Multi-Filter Store Locator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; background: #f5f9ff; }
    h2 { text-align: center; color: #004080; margin: 8px 0 16px; }

    .controls { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 860px) { .controls { grid-template-columns: repeat(4, 1fr); } }

    label { font-weight: bold; display: block; margin-bottom: 6px; }
    select {
      width: 100%; padding: 10px; font-size: 15px;
      border: 1px solid #d0d0d0; border-radius: 6px; background: #fff; box-sizing: border-box;
    }

    #map { width: 100%; height: 460px; border-radius: 10px; margin: 16px 0 20px; background: #fff; }
    #infoPanel {
      background: #fff; border: 1px solid #d0d0d0; border-radius: 8px;
      padding: 14px; line-height: 1.6; font-size: 15px;
    }

    a { color: #0066cc; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <h2>üó∫Ô∏è Barun ‚Äì DB ‚Üí DBSR ‚Üí Beat ‚Üí Customer</h2>

  <div class="controls">
    <div>
      <label for="dbSelect">DB Name</label>
      <select id="dbSelect"><option value="ALL">All</option></select>
    </div>
    <div>
      <label for="dbsrSelect">DBSR Name</label>
      <select id="dbsrSelect"><option value="ALL">All</option></select>
    </div>
    <div>
      <label for="beatSelect">Beat</label>
      <select id="beatSelect"><option value="ALL">All</option></select>
    </div>
    <div>
      <label for="customerSelect">Customer</label>
      <select id="customerSelect"><option value="ALL">All</option></select>
    </div>
  </div>

  <div id="map"></div>

  <div id="infoPanel">Pick filters to view outlets. Click a marker to see details.</div>

  <script>
    // Pulls the "Barun" tab directly
    const sheetURL = "https://opensheet.vercel.app/1Cx09yjWN8lju1jZENNuMB4nLdEV1NDTay_miEc6r0Ys/Barun";

    // Normalized data array: {db, dbsr, beat, customer, lat, lon}
    let data = [];
    let map, infoWindow;
    let markers = [];
    let userMarker = null, userLatLng = null;

    const $db   = () => document.getElementById("dbSelect");
    const $dbsr = () => document.getElementById("dbsrSelect");
    const $beat = () => document.getElementById("beatSelect");
    const $cust = () => document.getElementById("customerSelect");
    const $info = () => document.getElementById("infoPanel");

    const t = v => (v == null ? "" : String(v).trim());
    const n = v => { const x = parseFloat(v); return Number.isFinite(x) ? x : NaN; };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 23.3441, lng: 85.3096 }, // Ranchi
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
      });
      infoWindow = new google.maps.InfoWindow();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          userLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          userMarker = new google.maps.Marker({
            position: userLatLng, map, title: "Your Location",
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#007BFF", fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff" }
          });
        }, () => {});
      }
    }

    function clearMarkers(){ markers.forEach(m => m.setMap(null)); markers = []; }

    function fitToMarkers(includeUser = true) {
      const bounds = new google.maps.LatLngBounds();
      let any = false;
      markers.forEach(m => { bounds.extend(m.getPosition()); any = true; });
      if (includeUser && userLatLng) { bounds.extend(userLatLng); any = true; }
      if (any) {
        map.fitBounds(bounds);
        google.maps.event.addListenerOnce(map, "bounds_changed", () => {
          if (map.getZoom() > 15) map.setZoom(15);
        });
      }
    }

    function makeMarker(entry) {
      if (!Number.isFinite(entry.lat) || !Number.isFinite(entry.lon)) return null;
      const gmaps = `https://www.google.com/maps?q=${entry.lat},${entry.lon}`;
      const marker = new google.maps.Marker({
        map,
        position: { lat: entry.lat, lng: entry.lon },
        title: entry.customer || "(No name)",
      });
      marker.addListener("click", () => {
        infoWindow.setContent(`
          <div style="min-width:220px">
            <strong>${escapeHtml(entry.customer || "")}</strong><br/>
            DB: ${escapeHtml(entry.db || "-")}<br/>
            DBSR: ${escapeHtml(entry.dbsr || "-")}<br/>
            Beat: ${escapeHtml(entry.beat || "-")}<br/>
            <a href="${gmaps}" target="_blank">Open in Google Maps</a>
          </div>
        `);
        infoWindow.open(map, marker);

        // select in customer dropdown if present
        const custSel = document.getElementById("customerSelect");
        if (custSel) {
          const opt = [...custSel.options].find(o => o.value === (entry.customer || ""));
          if (opt) custSel.value = entry.customer || "";
        }
        renderInfoPanel([entry]);
      });
      return marker;
    }

    function renderMarkers(list) {
      clearMarkers();
      list.forEach(e => {
        const m = makeMarker(e);
        if (m) markers.push(m);
      });
      fitToMarkers(true);
    }

    function renderInfoPanel(list) {
      if (!list || list.length === 0) {
        $info().innerHTML = "No outlets match the current filters.";
        return;
      }
      if (list.length === 1) {
        const e = list[0];
        const link = (Number.isFinite(e.lat) && Number.isFinite(e.lon)) ? `https://www.google.com/maps?q=${e.lat},${e.lon}` : "#";
        $info().innerHTML = `
          <strong>${escapeHtml(e.customer || "")}</strong><br/>
          DB: ${escapeHtml(e.db || "-")}<br/>
          DBSR: ${escapeHtml(e.dbsr || "-")}<br/>
          Beat: ${escapeHtml(e.beat || "-")}<br/>
          ${Number.isFinite(e.lat) ? `Lat: ${e.lat}` : ""} ${Number.isFinite(e.lon) ? ` | Lon: ${e.lon}` : ""}<br/>
          <a href="${link}" target="_blank">Open in Google Maps</a>
        `;
      } else {
        $info().innerHTML = `Showing <strong>${list.length}</strong> outlets. Click a marker to see details.`;
      }
    }

    const escapeHtml = s => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    const uniqSorted = arr => [...new Set(arr.filter(v => t(v) !== ""))].sort((a,b)=>String(a).localeCompare(String(b),undefined,{sensitivity:'base'}));

    function populateSelect(el, values) {
      el.innerHTML = '<option value="ALL">All</option>' + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    }

    function applyFilters() {
      const dbVal   = $db().value;
      const dbsrVal = $dbsr().value;
      const beatVal = $beat().value;
      const custVal = $cust().value;

      let list = data.slice();
      if (dbVal   !== "ALL") list = list.filter(e => t(e.db)   === t(dbVal));
      if (dbsrVal !== "ALL") list = list.filter(e => t(e.dbsr) === t(dbsrVal));
      if (beatVal !== "ALL") list = list.filter(e => t(e.beat) === t(beatVal));
      if (custVal !== "ALL") list = list.filter(e => t(e.customer) === t(custVal));

      renderMarkers(list);
      renderInfoPanel(list);
    }

    function repopulateDownstream(from = "db") {
      // Rebuild downstream selects based on current upstream selections
      const dbVal   = $db().value;
      const dbsrVal = $dbsr().value;

      let list = data.slice();
      if (dbVal   !== "ALL") list = list.filter(e => t(e.db)   === t(dbVal));

      if (from === "db") {
        // rebuild DBSR, Beat, Customer
        populateSelect($dbsr(), uniqSorted(list.map(e => e.dbsr)));
        // fallthrough to rebuild Beat and Customer using current (possibly reset) dbsrVal
      }

      let list2 = list.slice();
      const _dbsr = $dbsr().value;
      if (_dbsr !== "ALL") list2 = list2.filter(e => t(e.dbsr) === t(_dbsr));
      populateSelect($beat(), uniqSorted(list2.map(e => e.beat)));

      let list3 = list2.slice();
      const _beat = $beat().value;
      if (_beat !== "ALL") list3 = list3.filter(e => t(e.beat) === t(_beat));
      populateSelect($cust(), uniqSorted(list3.map(e => e.customer)));
    }

    async function initData() {
      const res = await fetch(sheetURL);
      const raw = await res.json();

      // Normalize once so filters are robust (trims + parses)
      data = raw.map(r => ({
        db:       t(r["DB NAME"]),
        dbsr:     t(r["DBSR name"]),
        beat:     t(r["Beat"]),          // <-- Column M used here
        customer: t(r["Customer Name"]),
        lat:      n(r["Latitude"]),
        lon:      n(r["Longitude"]),
      }));

      populateSelect($db(), uniqSorted(data.map(e => e.db)));
      repopulateDownstream("db");
      applyFilters();
    }

    // Event wiring
    document.addEventListener("change", (e) => {
      if (e.target === $db())   { repopulateDownstream("db");   applyFilters(); }
      if (e.target === $dbsr()) { repopulateDownstream("dbsr"); applyFilters(); }
      if (e.target === $beat()) { repopulateDownstream("beat"); applyFilters(); }
      if (e.target === $cust()) { applyFilters(); }
    });

    // Kick off
    initData();
  </script>

  <!-- Google Maps JS API key (yours) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDmJhoaeBL3cDKrucjCZjmNm2uYi_WguL8&callback=initMap" async defer></script>
</body>
</html>
