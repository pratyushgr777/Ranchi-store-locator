<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barun – Multi-Filter Store Locator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.15);
      --text: #e8eefc;
      --muted: #a7b3d1;
      --accent: #6aa8ff;
      --accent-2: #6df0ff;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(108, 133, 255, 0.25), transparent 60%),
        radial-gradient(900px 700px at 110% 20%, rgba(0, 217, 255, 0.18), transparent 60%),
        radial-gradient(700px 500px at 50% 120%, rgba(71, 147, 255, 0.18), transparent 60%),
        var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
      line-height: 1.45;
    }

    /* Header */
    .appbar {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(140%) blur(8px);
      background: rgba(6, 10, 24, 0.6);
      border-bottom: 1px solid var(--stroke);
    }
    .appbar-inner {
      display: flex; align-items: center; justify-content: space-between;
      max-width: 1100px; margin: 0 auto; padding: 12px 16px;
    }
    .title {
      display: flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: .3px;
    }
    .title .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--accent-2), var(--accent));
      box-shadow: 0 0 12px var(--accent);
    }
    .app-actions { display: flex; gap: 8px; }

    .btn {
      appearance: none; border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      color: var(--text);
      padding: 10px 14px; border-radius: 10px;
      font-size: 15px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      box-shadow: var(--shadow);
      transition: transform .06s ease, border-color .2s ease;
      touch-action: manipulation;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      border-color: rgba(106, 168, 255, 0.6);
      background: linear-gradient(180deg, rgba(106,168,255,0.25), rgba(106,168,255,0.12));
    }

    /* Layout */
    .wrap {
      max-width: 1100px; margin: 16px auto; padding: 0 16px 24px;
      display: grid; gap: 16px;
    }

    /* Filters panel */
    .panel {
      border: 1px solid var(--stroke); border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel-head {
      display: none;
      align-items: center; justify-content: space-between;
      padding: 10px 14px; border-bottom: 1px solid var(--stroke);
    }
    .panel-head h3 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text); }
    .panel-content {
      display: grid; gap: 10px; padding: 12px; grid-template-columns: 1fr;
    }
    @media (min-width: 860px) {
      .panel-head { display: none; }
      .panel-content { grid-template-columns: repeat(4, 1fr); }
    }
    .field label {
      display: block; font-size: 13px; color: var(--muted);
      margin: 4px 2px 6px;
    }
    select {
      width: 100%; padding: 12px 12px; font-size: 15px; color: var(--text);
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--stroke); border-radius: 10px;
      outline: none;
    }
    select:focus { border-color: rgba(109, 240, 255, 0.55); }

    /* Map + info */
    .map-card {
      border: 1px solid var(--stroke); border-radius: var(--radius);
      background: var(--card); box-shadow: var(--shadow);
      overflow: hidden;
    }
    #map { width: 100%; height: 58vh; min-height: 360px; }
    .info {
      padding: 12px 14px; border-top: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    }
    .info p { margin: 0; color: var(--muted); }
    .info strong { color: var(--text); }

    /* Mobile filters toggle */
    .filters-toggle { display: inline-flex; }
    @media (min-width: 860px) { .filters-toggle { display: none; } }
    .panel.collapsed .panel-content { display: none; }

    /* Link */
    a { color: var(--accent-2); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Light-mode fallback */
    @media (prefers-color-scheme: light) {
      :root{
        --bg: #f4f7ff; --card: rgba(255,255,255,0.9); --stroke: rgba(27,47,74,0.12);
        --text: #0d2247; --muted: #4c6287; --accent: #2f6aff; --accent-2: #00a3ff;
        --shadow: 0 6px 24px rgba(12,37,80,0.16);
      }
      select { background: rgba(255,255,255,0.9); }
    }
  </style>
</head>
<body>

  <!-- Sticky header -->
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title">
        <span class="dot"></span>
        <span>Barun — Multi-Filter Locator</span>
      </div>
      <div class="app-actions">
        <button id="toggleFilters" class="btn filters-toggle" aria-expanded="true">Filters</button>
        <button id="useMyLocation" class="btn btn-primary">Use my location</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Filters -->
    <section id="filtersPanel" class="panel">
      <div class="panel-head">
        <h3>Filters</h3>
        <button id="toggleFilters2" class="btn">Close</button>
      </div>
      <div class="panel-content">
        <div class="field">
          <label for="dbSelect">DB Name</label>
          <select id="dbSelect"><option value="ALL">All</option></select>
        </div>
        <div class="field">
          <label for="dbsrSelect">DBSR Name</label>
          <select id="dbsrSelect"><option value="ALL">All</option></select>
        </div>
        <div class="field">
          <label for="beatSelect">Beat</label>
          <select id="beatSelect"><option value="ALL">All</option></select>
        </div>
        <div class="field">
          <label for="customerSelect">Customer</label>
          <select id="customerSelect"><option value="ALL">All</option></select>
        </div>
      </div>
    </section>

    <!-- Map + info -->
    <section class="map-card">
      <div id="map"></div>
      <div class="info">
        <p id="infoPanel">Pick filters to view outlets. Tap a marker for details.</p>
      </div>
    </section>
  </main>

  <script>
    // Data source: "Barun" tab
    const sheetURL = "https://opensheet.vercel.app/1Cx09yjWN8lju1jZENNuMB4nLdEV1NDTay_miEc6r0Ys/Barun";

    // Helpers
    const t = v => (v == null ? "" : String(v).trim());
    const n = v => { const x = parseFloat(v); return Number.isFinite(x) ? x : NaN; };
    const escapeHtml = s => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const uniqSorted = arr => [...new Set(arr.filter(v => t(v) !== ""))].sort((a,b)=>String(a).localeCompare(String(b),undefined,{sensitivity:'base'}));

    // Flexible header resolver
    function getVal(row, candidates) {
      for (const key of candidates) {
        if (key in row && t(row[key]) !== "") return row[key];
        const norm = s => String(s).toLowerCase().replace(/\s+/g," ").trim();
        const wanted = norm(key);
        for (const k in row) if (norm(k) === wanted && t(row[k]) !== "") return row[k];
      }
      return "";
    }

    // Column candidates (supports “Beat Name” and “Beat”)
    const CANDS = {
      DB:       ["DB NAME","DB Name","DB"],
      DBSR:     ["DBSR name","DBSR Name","DBSR"],
      BEAT:     ["Beat Name","Beat"],
      CUSTOMER: ["Customer Name","Customer"],
      LAT:      ["Latitude","Lat"],
      LON:      ["Longitude","Long","Lng"]
    };

    // State
    let data = []; // normalized rows: {db, dbsr, beat, customer, lat, lon}
    let map, infoWindow;
    let markers = [];
    let userMarker = null, userLatLng = null;

    // DOM
    const $db   = () => document.getElementById("dbSelect");
    const $dbsr = () => document.getElementById("dbsrSelect");
    const $beat = () => document.getElementById("beatSelect");
    const $cust = () => document.getElementById("customerSelect");
    const $info = () => document.getElementById("infoPanel");
    const $filtersPanel = () => document.getElementById("filtersPanel");

    // Build selects with raw values (keeps real comparison)
    function populateSelect(el, values, keepValue = true) {
      const prev = keepValue ? el.value : null;
      while (el.firstChild) el.removeChild(el.firstChild);

      const optAll = document.createElement('option');
      optAll.value = 'ALL'; optAll.textContent = 'All';
      el.appendChild(optAll);

      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        el.appendChild(opt);
      });

      if (keepValue && prev && (prev === 'ALL' || values.includes(prev))) el.value = prev;
    }

    /* MAP */
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 23.3441, lng: 85.3096 },
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
      });
      infoWindow = new google.maps.InfoWindow();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          userLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          userMarker = new google.maps.Marker({
            position: userLatLng, map, title: "Your Location",
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#6aa8ff", fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff" }
          });
        }, () => {});
      }
    }
    function clearMarkers(){ markers.forEach(m => m.setMap(null)); markers = []; }
    function fitToMarkers(includeUser = true) {
      const bounds = new google.maps.LatLngBounds();
      let any = false;
      markers.forEach(m => { bounds.extend(m.getPosition()); any = true; });
      if (includeUser && userLatLng) { bounds.extend(userLatLng); any = true; }
      if (any) {
        map.fitBounds(bounds);
        google.maps.event.addListenerOnce(map, "bounds_changed", () => {
          if (map.getZoom() > 15) map.setZoom(15);
        });
      }
    }
    function makeMarker(entry) {
      if (!Number.isFinite(entry.lat) || !Number.isFinite(entry.lon)) return null;
      const gmaps = `https://www.google.com/maps?q=${entry.lat},${entry.lon}`;
      const marker = new google.maps.Marker({
        map,
        position: { lat: entry.lat, lng: entry.lon },
        title: entry.customer || "(No name)",
      });
      marker.addListener("click", () => {
        infoWindow.setContent(`
          <div style="min-width:220px">
            <strong>${escapeHtml(entry.customer || "")}</strong><br/>
            DB: ${escapeHtml(entry.db || "-")}<br/>
            DBSR: ${escapeHtml(entry.dbsr || "-")}<br/>
            Beat: ${escapeHtml(entry.beat || "-")}<br/>
            <a href="${gmaps}" target="_blank">Open in Google Maps</a>
          </div>
        `);
        infoWindow.open(map, marker);
        const custSel = $cust();
        if (custSel) {
          const match = [...custSel.options].find(o => o.value === (entry.customer || ""));
          if (match) custSel.value = entry.customer || "";
        }
        renderInfoPanel([entry]);
      });
      return marker;
    }
    function renderMarkers(list) {
      clearMarkers();
      list.forEach(e => { const m = makeMarker(e); if (m) markers.push(m); });
      fitToMarkers(true);
    }
    function renderInfoPanel(list) {
      if (!list || list.length === 0) {
        $info().innerHTML = "No outlets match the current filters.";
        return;
      }
      if (list.length === 1) {
        const e = list[0];
        const link = (Number.isFinite(e.lat) && Number.isFinite(e.lon)) ? `https://www.google.com/maps?q=${e.lat},${e.lon}` : "#";
        $info().innerHTML = `
          <strong>${escapeHtml(e.customer || "")}</strong><br/>
          DB: ${escapeHtml(e.db || "-")}<br/>
          DBSR: ${escapeHtml(e.dbsr || "-")}<br/>
          Beat: ${escapeHtml(e.beat || "-")}<br/>
          ${Number.isFinite(e.lat) ? `Lat: ${e.lat}` : ""} ${Number.isFinite(e.lon) ? ` | Lon: ${e.lon}` : ""}<br/>
          <a href="${link}" target="_blank">Open in Google Maps</a>
        `;
      } else {
        $info().innerHTML = `Showing <strong>${list.length}</strong> outlets. Tap a marker for details.`;
      }
    }

    /* DATA + FILTERS */
    function filteredList() {
      const dbVal   = $db().value;
      const dbsrVal = $dbsr().value;
      const beatVal = $beat().value;
      const custVal = $cust().value;

      let list = data.slice();
      if (dbVal   !== "ALL") list = list.filter(e => t(e.db)   === t(dbVal));
      if (dbsrVal !== "ALL") list = list.filter(e => t(e.dbsr) === t(dbsrVal));
      if (beatVal !== "ALL") list = list.filter(e => t(e.beat) === t(beatVal));
      if (custVal !== "ALL") list = list.filter(e => t(e.customer) === t(custVal));
      return list;
    }
    function rebuildDBSR() {
      const dbVal = $db().value;
      let list = data.slice();
      if (dbVal !== "ALL") list = list.filter(e => t(e.db) === t(dbVal));
      populateSelect($dbsr(), uniqSorted(list.map(e => e.dbsr)), true);
    }
    function rebuildBeat() {
      const dbVal = $db().value, dbsrVal = $dbsr().value;
      let list = data.slice();
      if (dbVal   !== "ALL") list = list.filter(e => t(e.db)   === t(dbVal));
      if (dbsrVal !== "ALL") list = list.filter(e => t(e.dbsr) === t(dbsrVal));
      populateSelect($beat(), uniqSorted(list.map(e => e.beat)), true);
    }
    function rebuildCustomer() {
      const list = filteredList(); // uses current DB/DBSR/Beat
      populateSelect($cust(), uniqSorted(list.map(e => e.customer)), false);
    }
    function applyFiltersAndRender() {
      const list = filteredList();
      renderMarkers(list);
      renderInfoPanel(list);
    }

    async function initData() {
      const res = await fetch(sheetURL);
      const raw = await res.json();

      data = raw.map(r => ({
        db:       t(getVal(r, CANDS.DB)),
        dbsr:     t(getVal(r, CANDS.DBSR)),
        beat:     t(getVal(r, CANDS.BEAT)),     // supports "Beat Name" or "Beat"
        customer: t(getVal(r, CANDS.CUSTOMER)),
        lat:      n(getVal(r, CANDS.LAT)),
        lon:      n(getVal(r, CANDS.LON)),
      }));

      populateSelect($db(), uniqSorted(data.map(e => e.db)), true);
      rebuildDBSR(); rebuildBeat(); rebuildCustomer();
      applyFiltersAndRender();
    }

    // Event wiring with selection preservation
    $db().addEventListener("change", () => {
      rebuildDBSR(); rebuildBeat(); rebuildCustomer(); applyFiltersAndRender();
    });
    $dbsr().addEventListener("change", () => {
      rebuildBeat(); rebuildCustomer(); applyFiltersAndRender();
    });
    $beat().addEventListener("change", () => {
      rebuildCustomer(); applyFiltersAndRender();
    });
    $cust().addEventListener("change", () => applyFiltersAndRender());

    // Header buttons
    document.getElementById("useMyLocation").addEventListener("click", () => {
      if (userLatLng) { map.setCenter(userLatLng); map.setZoom(14); }
      else alert("Couldn't access your location yet. Please allow location permissions.");
    });
    const toggleBtn = document.getElementById("toggleFilters");
    const toggleBtn2 = document.getElementById("toggleFilters2");
    function toggleFilters(){
      const panel = $filtersPanel();
      panel.classList.toggle("collapsed");
      const open = !panel.classList.contains("collapsed");
      toggleBtn.setAttribute("aria-expanded", open ? "true" : "false");
    }
    toggleBtn.addEventListener("click", toggleFilters);
    if (toggleBtn2) toggleBtn2.addEventListener("click", toggleFilters);

    // Boot
    initData();
  </script>

  <!-- Google Maps JS API key (yours) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDmJhoaeBL3cDKrucjCZjmNm2uYi_WguL8&callback=initMap" async defer></script>
</body>
</html>
