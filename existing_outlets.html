<!DOCTYPE html>
<html>
<head>
  <title>Existing Outlets Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { color: #004080; text-align: center; }
    .filters {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    label {
      font-weight: bold;
    }
    select {
      padding: 8px;
      font-size: 15px;
    }
    .button {
      padding: 8px 12px;
      background-color: #007BFF;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #004080;
      color: white;
    }
    #backBtn {
      margin-bottom: 20px;
      display: inline-block;
    }
  </style>
</head>
<body>

<a id="backBtn" class="button" href="https://pratyushgr777.github.io/Ranchi-store-locator/index.html">‚Üê Back to Store Locator</a>

<h2>Existing Outlets Tracker</h2>

<div class="filters">
  <div>
    <label for="routeNameSelect">DBSR Name:</label><br>
    <select id="routeNameSelect" onchange="onRouteNameChange()">
      <option value="">All Names</option>
    </select>
  </div>

  <div>
    <label for="routePlanSelect">BEAT:</label><br>
    <select id="routePlanSelect" onchange="filterDropdowns()">
      <option value="">All Beats</option>
    </select>
  </div>
</div>

<table id="outletsTable">
  <thead>
    <tr>
      <th>Customer Name</th>
      <th>BEAT</th>
      <th>DBSR Name</th>
      <th>DB Name</th>
      <th>Map</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <tr><td colspan="5">Loading data...</td></tr>
  </tbody>
</table>

<script>
  const sheetID = "1Cx09yjWN8lju1jZENNuMB4nLdEV1NDTay_miEc6r0Ys";
  const sheetName = "Existing Outlets";
  const query = encodeURIComponent("Select *");
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

  let allRows = [];

  fetch(url)
    .then(res => res.text())
    .then(rep => {
      const data = JSON.parse(rep.substr(47).slice(0, -2));
      allRows = data.table.rows;
      populateDBSRDropdown();
      renderTable(allRows);
    });

  function populateDBSRDropdown() {
    const dbsrNames = new Set();

    allRows.forEach(row => {
      const dbsrName = row.c[8]?.v || "";
      if (dbsrName) dbsrNames.add(dbsrName);
    });

    const routeNameSelect = document.getElementById("routeNameSelect");

    [...dbsrNames].sort().forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.text = name;
      routeNameSelect.appendChild(option);
    });
  }

  function onRouteNameChange() {
    const selectedDBSR = document.getElementById("routeNameSelect").value;
    populateBeatDropdown(selectedDBSR);
    filterDropdowns();
  }

  function populateBeatDropdown(selectedDBSR) {
    const beatSet = new Set();

    allRows.forEach(row => {
      const dbsr = row.c[8]?.v || "";
      const beat = row.c[9]?.v || "";
      if (!selectedDBSR || dbsr === selectedDBSR) {
        if (beat) beatSet.add(beat);
      }
    });

    const routePlanSelect = document.getElementById("routePlanSelect");
    routePlanSelect.innerHTML = '<option value="">All Beats</option>';

    [...beatSet].sort().forEach(beat => {
      const option = document.createElement("option");
      option.value = beat;
      option.text = beat;
      routePlanSelect.appendChild(option);
    });
  }

  function renderTable(rows) {
    const tableBody = document.getElementById("tableBody");
    let tableContent = "";

    rows.forEach(row => {
      const customerName = row.c[3]?.v || "";
      const routeDesc = row.c[9]?.v || "";
      const routeName = row.c[8]?.v || "";
      const dbName = row.c[1]?.v || "";
      const lat = row.c[4]?.v || "";
      const lon = row.c[5]?.v || "";
      const mapLink = (lat && lon) ? `https://www.google.com/maps?q=${lat},${lon}` : "#";

      tableContent += `
        <tr>
          <td>${customerName}</td>
          <td>${routeDesc}</td>
          <td>${routeName}</td>
          <td>${dbName}</td>
          <td><a class="button" href="${mapLink}" target="_blank">Map</a></td>
        </tr>`;
    });

    tableBody.innerHTML = tableContent || "<tr><td colspan='5'>No matching data</td></tr>";
  }

  function filterDropdowns() {
    const dbsrValue = document.getElementById("routeNameSelect").value;
    const beatValue = document.getElementById("routePlanSelect").value;

    const filtered = allRows.filter(row => {
      const dbsr = row.c[8]?.v || "";
      const beat = row.c[9]?.v || "";

      const dbsrMatch = !dbsrValue || dbsr === dbsrValue;
      const beatMatch = !beatValue || beat === beatValue;

      return dbsrMatch && beatMatch;
    });

    renderTable(filtered);
  }
</script>

</body>
</html>
